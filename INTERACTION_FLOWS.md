# MemeX 前后端与合约交互流程说明

本文档详细说明前后端如何与 memeX 智能合约系统进行交互的流程，重点关注业务逻辑和数据流向。

## 📋 目录

- [系统架构概览](#系统架构概览)
- [用户交互流程](#用户交互流程)
- [前端与合约交互](#前端与合约交互)
- [后端与合约交互](#后端与合约交互)
- [数据同步流程](#数据同步流程)
- [监控和运维流程](#监控和运维流程)

---

## 🏗️ 系统架构概览

### 核心合约结构

```
用户应用 → PredictionRouter (主入口) → 各功能合约
                    ↓
        ┌───────────┴───────────┐
        ↓                       ↓
  事件管理层                 支付管理层
PredictionFactory       X404PaymentProcessor
        ↓                       ↓
    BinaryOption              AI Oracle
        ↓                       ↓
  数据管理层                 管理控制层
PriceOracle              RiskManager/Treasury
                            ↓
                     AccessController
```

### 各合约职责分工

- **PredictionRouter**: 统一用户入口，协调各功能模块
- **PredictionFactory**: 事件创建工厂，管理事件生命周期
- **BinaryOption**: 单个预测事件合约，处理下注和结算
- **PriceOracle**: 价格数据提供者，从Chainlink获取价格
- **X404PaymentProcessor**: AI预测服务支付处理
- **RiskManager**: 风险控制和用户行为管理
- **Treasury**: 平台资金管理和费用分配
- **AccessController**: 权限管理和紧急控制

---

## 🎯 用户交互流程

### 1. 基础下注流程

**用户操作步骤：**
1. 选择代币和目标价格
2. 设置预测时长（1小时-30天）
3. 选择下注方向（YES/NO）
4. 输入下注金额
5. 确认交易并支付

**合约交互流程：**
```
用户发起请求
    ↓
PredictionRouter.createAndBet()
    ↓
PredictionFactory.createEvent() (创建新事件)
    ↓
BinaryOption.placeBet() (执行下注)
    ↓
RiskManager.validateBet() (风险检查)
    ↓
Treasury.collectFee() (收取平台费)
    ↓
返回事件地址和交易结果
```

### 2. AI智能投注流程

**用户操作步骤：**
1. 选择已有预测事件
2. 输入AI分析问题
3. 选择AI服务等级（基础/高级/批量）
4. 支付AI预测费用（X404代币）
5. 确认AI推荐的投注方案

**合约交互流程：**
```
用户请求AI预测
    ↓
X404PaymentProcessor.payForPrediction() (支付AI费用)
    ↓
AI Oracle.getRecommendation() (获取AI建议)
    ↓
PredictionRouter.intelligentBet() (执行智能投注)
    ↓
BinaryOption.placeBet() (下注到推荐方向)
    ↓
返回AI请求ID和投注结果
```

### 3. 批量下注流程

**用户操作步骤：**
1. 选择多个预测事件
2. 为每个事件设置下注参数
3. 可选择是否使用AI辅助
4. 确认批量交易
5. 一次性支付所有费用

**合约交互流程：**
```
用户提交批量请求
    ↓
PredictionRouter.batchBet()
    ↓
逐个验证每个下注参数
    ↓
RiskManager.batchValidate() (批量风险检查)
    ↓
逐个执行 BinaryOption.placeBet()
    ↓
批量收取平台费用
    ↓
返回批量执行结果
```

### 4. 事件结算流程

**自动结算流程：**
```
事件到期时间到达
    ↓
后端服务检测到期事件
    ↓
PriceOracle.getLatestPrice() (获取最终价格)
    ↓
BinaryOption.settle() (执行结算)
    ↓
计算用户奖金
    ↓
通知用户领取奖金
```

### 5. 奖金领取流程

**用户操作步骤：**
1. 查看已结算事件
2. 确认可领取奖金
3. 发起奖金领取交易
4. 奖金转入用户钱包

**合约交互流程：**
```
用户请求领取奖金
    ↓
PredictionRouter.batchClaimWinnings()
    ↓
验证用户中奖资格
    ↓
BinaryOption.claimWinnings() (支付奖金)
    ↓
Treasury.releaseFunds() (释放资金)
    ↓
更新用户奖金状态
```

---

## 🎨 前端与合约交互

### 1. 钱包连接流程

**连接流程：**
1. 检测浏览器钱包（MetaMask等）
2. 请求连接钱包授权
3. 获取用户钱包地址
4. 检查网络是否匹配
5. 如不匹配，提示用户切换网络

### 2. 数据查询流程

**实时数据获取：**
```
页面加载
    ↓
连接合约实例
    ↓
获取用户活跃事件列表
    ↓
获取每个事件详细信息
    ↓
获取实时价格数据
    ↓
计算赔率和奖金池
    ↓
更新页面显示
```

**历史数据查询：**
1. 获取用户历史下注记录
2. 查询事件历史价格数据
3. 获取已结算事件结果
4. 统计用户收益和胜率

### 3. 事件监听流程

**实时更新机制：**
```
建立事件监听
    ↓
监听下注事件 → 更新奖金池和赔率
    ↓
监听价格事件 → 更新代币价格显示
    ↓
监听结算事件 → 更新事件状态
    ↓
监听奖金事件 → 更新用户余额
    ↓
实时刷新页面数据
```

### 4. 交易执行流程

**通用交易流程：**
1. 构建交易参数
2. 显示交易预览（费用、Gas等）
3. 用户确认交易
4. 发送到钱包签名
5. 等待区块链确认
6. 处理交易结果

### 5. 错误处理流程

**常见错误处理：**
- **网络错误**: 提示检查网络连接
- **余额不足**: 提示充值或选择其他代币
- **权限错误**: 提示连接钱包或切换账户
- **交易失败**: 显示具体失败原因
- **Gas不足**: 建议提高Gas费用

---

## 🔧 后端与合约交互

### 1. 数据同步流程

**事件数据同步：**
```
定时任务启动（每分钟）
    ↓
查询新区块中的事件创建事件
    ↓
解析事件数据并存储到数据库
    ↓
更新事件状态和基本信息
    ↓
同步相关用户下注数据
    ↓
记录同步日志
```

**价格数据同步：**
1. 定时获取各代币最新价格
2. 计算价格变化趋势
3. 检测价格异常波动
4. 更新价格数据库
5. 触发价格相关事件

### 2. 事件管理流程

**自动事件管理：**
```
扫描即将到期事件
    ↓
检查是否需要手动结算
    ↓
获取最终价格数据
    ↓
执行合约结算操作
    ↓
计算用户奖金
    ↓
通知用户领取奖金
```

**事件监控流程：**
1. 监控事件创建数量
2. 跟踪事件参与度
3. 检测异常事件行为
4. 统计平台运营数据

### 3. 风险管理流程

**实时风险监控：**
```
用户发起下注请求
    ↓
RiskManager.validateBet() (检查用户风险)
    ↓
检查用户下注限额
    ↓
检查资金池规模限制
    ↓
检测异常行为模式
    ↓
如发现风险，拒绝下注
```

**系统性风险控制：**
- 监控总风险敞口
- 检测市场异常波动
- 触发熔断机制
- 限制高风险用户

### 4. 资金管理流程

**费用收取流程：**
```
用户下注成功
    ↓
Treasury.collectFee() (收取平台费)
    ↓
费用分配到不同账户
    ↓
更新财库余额
    ↓
记录财务数据
```

**资金分配流程：**
1. 平台储备金分配
2. 流动性提供者奖励
3. AI服务提供者费用
4. 团队奖励分配

### 5. 运维管理流程

**系统监控流程：**
```
定时健康检查
    ↓
检查合约可用性
    ↓
监控系统性能指标
    ↓
检测异常交易行为
    ↓
生成监控报告
    ↓
触发异常告警
```

**紧急处理流程：**
1. 检测系统异常
2. 触发紧急暂停
3. 通知运营团队
4. 分析问题原因
5. 执行修复操作
6. 恢复系统运行

---

## 📊 数据同步流程

### 1. 实时数据同步

**事件数据流：**
```
区块链事件 → 后端监听 → 数据库存储 → 前端更新
    ↓
下注事件 → 用户下注记录 → 实时奖金池更新
    ↓
结算事件 → 事件结果更新 → 用户奖金计算
    ↓
价格事件 → 代币价格更新 → 赔率重新计算
```

### 2. 历史数据同步

**数据回溯流程：**
1. 从创世区块开始扫描
2. 分批处理历史事件
3. 建立完整数据索引
4. 验证数据一致性
5. 完成数据迁移

### 3. 数据验证流程

**数据一致性检查：**
```
链上数据 vs 数据库数据
    ↓
检查事件状态一致性
    ↓
验证用户下注记录
    ↓
确认金额计算正确
    ↓
如有不一致，触发修复
```

---

## 🔍 监控和运维流程

### 1. 系统健康监控

**健康检查项目：**
- 区块链连接状态
- 合约响应时间
- Gas费用监控
- 数据库性能
- API服务可用性

### 2. 业务监控

**关键业务指标：**
- 日活跃用户数
- 事件创建数量
- 总交易金额
- 平台收入统计
- 用户满意度指标

### 3. 安全监控

**安全检查项目：**
- 异常交易检测
- 用户行为分析
- 合约权限监控
- 资金流向跟踪
- 攻击行为识别

### 4. 性能监控

**性能指标监控：**
- 交易处理速度
- 数据库查询性能
- 前端页面加载时间
- API响应时间
- 错误率统计

### 5. 告警处理流程

**告警级别分类：**
- **信息级**: 常规业务提醒
- **警告级**: 需要关注的异常
- **错误级**: 需要及时处理的问题
- **严重级**: 系统故障或安全事件

**告警处理流程：**
1. 检测到异常条件
2. 生成告警信息
3. 发送通知给相关人员
4. 记录告警日志
5. 跟踪处理进度
6. 确认问题解决

---

## 🔄 异常处理流程

### 1. 交易失败处理

**常见失败原因：**
- Gas费用不足
- 网络拥堵
- 合约执行失败
- 权限不足
- 余额不够

**处理策略：**
- 提供具体的失败原因
- 建议解决方案
- 重试机制
- 状态恢复

### 2. 数据同步失败处理

**失败处理流程：**
1. 检测同步失败
2. 记录错误日志
3. 重新尝试同步
4. 如持续失败，告警通知
5. 手动介入处理

### 3. 系统异常恢复

**恢复流程：**
1. 确定异常范围
2. 评估影响程度
3. 制定恢复方案
4. 执行恢复操作
5. 验证系统正常
6. 总结经验教训

---

## 📝 业务规则说明

### 1. 下注规则

- 最小下注金额：0.001 ETH/USDT
- 最大下注金额：10,000 ETH/USDT
- 单个事件最大资金池：1,000,000 ETH/USDT
- 平台费用：3%

### 2. 结算规则

- 事件到期后自动结算
- 使用Chainlink价格作为最终价格
- 价格偏差超过5%时触发警报
- 结算后24小时内可领取奖金

### 3. 风险控制规则

- 用户单日最大风险敞口：50,000 ETH/USDT
- 连胜/连败限制：10次
- 异常行为检测：频率和金额异常
- 系统熔断阈值：500,000 ETH/USDT

### 4. AI服务规则

- 基础预测：10 X404代币
- 高级预测：50 X404代币
- 批量预测：100 X404代币
- VIP用户可享受20%折扣

---

这个流程文档清晰地说明了前后端与合约交互的各个环节，为开发团队提供了完整的业务逻辑指导。